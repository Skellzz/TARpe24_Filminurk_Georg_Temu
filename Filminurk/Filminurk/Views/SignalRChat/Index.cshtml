@model Filminurk.Models.Chat.ChatViewModel

<h2>Jututuba</h2>

<div style="display:flex; gap:20px;">
    <div style="width:250px;">
        <h4>Online</h4>
        <ul id="users"></ul>
    </div>

    <div style="flex:1;">
        <div id="chat" style="border:1px solid #ccc; height:300px; overflow:auto; padding:10px;"></div>

        <div style="margin-top:10px;">
            <input id="message" placeholder="Kirjuta siia..." style="width:80%;" />
            <button id="send">Saada</button>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.20/signalr.min.js"></script>
<script>
    const chat = document.getElementById("chat");
    const usersUl = document.getElementById("users");
    const messageInput = document.getElementById("message");
    const sendBtn = document.getElementById("send");

    const users = new Map();

    function renderUsers() {
        usersUl.innerHTML = "";
        [...users.values()].sort().forEach(name => {
            const li = document.createElement("li");
            li.textContent = name;
            usersUl.appendChild(li);
        });
    }

    function addMessage(name, message) {
        const div = document.createElement("div");
        div.innerHTML = `<strong>${escapeHtml(name)}:</strong> ${escapeHtml(message)}`;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    function escapeHtml(s) {
        return (s ?? "").replace(/[&<>"']/g, m => ({
            "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
        }[m]));
    }

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chathub")
        .withAutomaticReconnect()
        .build();

    connection.on("OnlineUsers", (list) => {
        users.clear();
        (list || []).forEach(u => users.set(u.userId, u.name));
        renderUsers();
    });

    connection.on("UserConnected", (u) => {
        if (u && u.userId) {
            users.set(u.userId, u.name);
            renderUsers();
        }
    });

    connection.on("UserDisconnected", (u) => {
        if (u && u.userId) {
            users.delete(u.userId);
            renderUsers();
        }
    });

    connection.on("ReceiveMessage", (m) => {
        addMessage(m.name, m.message);
    });

    async function start() {
        try {
            await connection.start();
        } catch (e) {
            console.error(e);
            setTimeout(start, 2000);
        }
    }

    sendBtn.addEventListener("click", async () => {
        const msg = messageInput.value;
        if (!msg.trim()) return;
        messageInput.value = "";
        await connection.invoke("SendMessage", msg);
    });

    messageInput.addEventListener("keydown", async (e) => {
        if (e.key === "Enter") sendBtn.click();
    });

    start();
</script>
