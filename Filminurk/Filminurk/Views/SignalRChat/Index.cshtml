@model Filminurk.Models.Chat.ChatViewModel

<h2>Jututuba</h2>

<div id="status" style="margin-bottom:10px; padding:8px; border:1px solid #ccc;">
    Status: <strong id="statusText">Loading...</strong>
    <div id="statusError" style="color:red;"></div>
</div>

<div style="display:flex; gap:20px;">
    <div style="width:250px;">
        <h4>Online</h4>
        <ul id="users"></ul>
    </div>

    <div style="flex:1;">
        <div id="chat" style="border:1px solid #ccc; height:300px; overflow:auto; padding:10px;"></div>

        <div style="margin-top:10px;">
            <input id="message" placeholder="Kirjuta siia..." style="width:80%;" />
            <button id="send" type="button" disabled>Saada</button>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/@@microsoft/signalr@7.0.20/dist/browser/signalr.min.js"></script>

<script>
    const statusText = document.getElementById("statusText");
    const statusError = document.getElementById("statusError");
    const sendBtn = document.getElementById("send");
    const messageInput = document.getElementById("message");
    const chat = document.getElementById("chat");
    const usersUl = document.getElementById("users");

    function setStatus(text, err) {
        statusText.textContent = text;
        statusError.textContent = err || "";
    }

    if (!window.signalR) {
        setStatus("ERROR", "SignalR JS ei laadinud. Kontrolli CDN-i.");
        throw new Error("signalR not loaded");
    }

    const users = new Map();

    function renderUsers() {
        usersUl.innerHTML = "";
        [...users.values()].forEach(name => {
            const li = document.createElement("li");
            li.textContent = name;
            usersUl.appendChild(li);
        });
    }

    function addMessage(name, msg) {
        const div = document.createElement("div");
        div.innerHTML = "<b>" + name + ":</b> " + msg;
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
    }

    const connection = new signalR.HubConnectionBuilder()
        .withUrl("/chathub")
        .withAutomaticReconnect()
        .build();

    connection.on("OnlineUsers", list => {
        users.clear();
        list.forEach(u => users.set(u.userId, u.name));
        renderUsers();
    });

    connection.on("UserConnected", u => {
        users.set(u.userId, u.name);
        renderUsers();
    });

    connection.on("UserDisconnected", u => {
        users.delete(u.userId);
        renderUsers();
    });

    connection.on("ReceiveMessage", m => {
        addMessage(m.name, m.message);
    });

    sendBtn.onclick = async () => {
        const msg = messageInput.value.trim();
        if (!msg) return;

        await connection.invoke("SendMessage", msg);
        messageInput.value = "";
    };

    async function start() {
        try {
            setStatus("Connecting...");
            await connection.start();
            setStatus("Connected");
            sendBtn.disabled = false;
        } catch (err) {
            setStatus("Disconnected", err.toString());
            setTimeout(start, 2000);
        }
    }

    start();
</script>
